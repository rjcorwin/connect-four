<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>fiar-game test</title>

    <script src="../../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../node_modules/wct-browser-legacy/browser.js"></script>

  </head>
  <body>

    <test-fixture id="BasicTestFixture">
      <template>
        <fiar-game></fiar-game>
      </template>
    </test-fixture>

    <test-fixture id="AiTestFixture">
      <template>
        <fiar-game ai-enabled></fiar-game>
      </template>
    </test-fixture>

    <script type="module">
      import {reducer} from '../src/reducer.js'
      import { createStore } from "redux/es/redux.js";

      suite('fiar-reducer', function() {

        test('Should move to point given angle of 0', function() {
          const store = createStore(reducer)
          store.dispatch({
            type: 'ADD_OBJECT',  
            object: {
              id: 1,
              a: 0,
              x: 50,
              y: 50,
              expires: 0,
              ticks: 0
            }
          })
          store.dispatch({type: 'TICK'})
          assert.equal(store.getState().objects.find(obj => obj.id === 1).x, 50)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).y, 51)
          store.dispatch({type: 'TICK'})
          assert.equal(store.getState().objects.find(obj => obj.id === 1).x, 50)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).y, 52)
        })

        test('Should move to point given angle of 90', function() {
          const store = createStore(reducer)
          store.dispatch({
            type: 'ADD_OBJECT',  
            object: {
              id: 1,
              a: 90,
              x: 50,
              y: 50,
              expires: 0,
              ticks: 0
            }
          })
          store.dispatch({type: 'TICK'})
          assert.equal(store.getState().objects.find(obj => obj.id === 1).x, 51)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).y, 50)
          store.dispatch({type: 'TICK'})
          assert.equal(store.getState().objects.find(obj => obj.id === 1).x, 52)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).y, 50)
        })

        test('Should move to point given angle of 180', function() {
          const store = createStore(reducer)
          store.dispatch({
            type: 'ADD_OBJECT',  
            object: {
              id: 1,
              a: 180,
              x: 50,
              y: 50,
              expires: 0,
              ticks: 0
            }
          })
          store.dispatch({type: 'TICK'})
          assert.equal(store.getState().objects.find(obj => obj.id === 1).x, 50)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).y, 49)
          store.dispatch({type: 'TICK'})
          assert.equal(store.getState().objects.find(obj => obj.id === 1).x, 50)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).y, 48)
        })

        test('Should move to point given angle of 270', function() {
          const store = createStore(reducer)
          store.dispatch({
            type: 'ADD_OBJECT',  
            object: {
              id: 1,
              a: 270,
              x: 50,
              y: 50,
              expires: 0,
              ticks: 0
            }
          })
          store.dispatch({type: 'TICK'})
          assert.equal(store.getState().objects.find(obj => obj.id === 1).x, 49)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).y, 50)
          store.dispatch({type: 'TICK'})
          assert.equal(store.getState().objects.find(obj => obj.id === 1).x, 48)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).y, 50)
        })
        
        test('should change object\'s angle', function() {
          const store = createStore(reducer)
          store.dispatch({
            type: 'ADD_OBJECT',  
            object: {
              id: 1,
              a: 180,
              x: 50,
              y: 50,
              expires: 0,
              ticks: 0
            }
          })
          store.dispatch({type: 'TICK'})
          assert.equal(store.getState().objects.find(obj => obj.id === 1).x, 50)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).y, 49)
          store.dispatch({type: 'TURN_OBJECT_UP', objectId: 1})
          store.dispatch({type: 'TICK'})
          assert.equal(store.getState().objects.find(obj => obj.id === 1).x, 50)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).y, 50)
        })

        test('should initialize with boundary wall', () => {
          const store = createStore(reducer)
          store.dispatch({type: 'NEW_GAME', settings: {
            xBound: 30,
            yBound: 30,
            tailExpiration: 5
          }})
          debugger
          // Check for objects in corners.
          assert.equal(store.getState().objects.find(obj => obj.x === 0 && obj.y === 0).a, undefined)
          assert.equal(store.getState().objects.find(obj => obj.x === 30 && obj.y === 0).a, undefined)
          assert.equal(store.getState().objects.find(obj => obj.x === 0 && obj.y === 30).a, undefined)
          assert.equal(store.getState().objects.find(obj => obj.x === 30 && obj.y === 30).a, undefined)
          // Check for a couple other random parts of the wall.
          assert.equal(store.getState().objects.find(obj => obj.x === 10 && obj.y === 30).a, undefined)
          assert.equal(store.getState().objects.find(obj => obj.x === 30 && obj.y === 10).a, undefined)
          assert.equal(store.getState().objects.find(obj => obj.x === 0 && obj.y === 10).a, undefined)
          assert.equal(store.getState().objects.find(obj => obj.x === 10 && obj.y === 0).a, undefined)
          // Total wall blocks.
          assert.equal(store.getState().objects.length, 106)

        })

        test('two objects with velocity should collide', () => {
          const store = createStore(reducer)
          store.dispatch({
            type: 'ADD_OBJECT',  
            object: {
              id: 1,
              a: 90,
              x: 50,
              y: 50,
              expires: 0,
              ticks: 0
            }
          })
          store.dispatch({
            type: 'ADD_OBJECT',  
            object: {
              id: 2,
              a: 270,
              x: 52,
              y: 50,
              expires: 0,
              ticks: 0
            }
          })
          store.dispatch({type: 'TICK'})
          assert.equal(store.getState().objects.find(obj => obj.id === 1).x, 50)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).y, 50)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).collision, true)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).a, undefined)
        })

        test('object with velocity should get stuck next to object without velocity', () => {
          const store = createStore(reducer)
          store.dispatch({
            type: 'ADD_OBJECT',  
            object: {
              id: 1,
              v: 10,
              a: 0,
              x: 50,
              y: 50,
              expires: 0,
              ticks: 0
            }
          })
          store.dispatch({
            type: 'ADD_OBJECT',  
            object: {
              id: 2,
              v: 0,
              a: undefined,
              x: 50,
              y: 52,
              expires: 0,
              ticks: 0
            }
          })
          store.dispatch({type: 'TICK'})
          assert.equal(store.getState().objects.find(obj => obj.id === 1).x, 50)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).y, 51)
          store.dispatch({type: 'TICK'})
          assert.equal(store.getState().objects.find(obj => obj.id === 1).x, 50)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).y, 51)
          assert.equal(store.getState().objects.find(obj => obj.id === 1).a, undefined)

        }) 

      })

    </script>


  </body>
</html>
